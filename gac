#!/usr/bin/env bash

# gac (Git AI Commit) - AI-powered Git commit message generator
# Usage: gac [options]

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration defaults
CONFIG_FILE="${HOME}/.config/gac.conf"
MAX_DIFF_LINES=500
LANGUAGE="en"
COMMIT_FORMAT="conventional"

# Load configuration if exists
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
fi

# Function to print colored messages
print_error() {
    echo -e "${RED}❌ Error: $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}✅ $1${NC}" >&2
}

print_info() {
    echo -e "${BLUE}ℹ️  $1${NC}" >&2
}

print_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}" >&2
}

# Function to check if we're in a git repository
check_git_repo() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        print_error "Not a git repository"
        exit 1
    fi
}

# Function to check if there are staged changes
check_staged_changes() {
    if git diff --cached --quiet; then
        print_error "No staged changes found. Please stage your changes first with 'git add'"
        exit 1
    fi
}

# Function to get diff stats
get_diff_stats() {
    local files_changed=$(git diff --cached --numstat | wc -l)
    local insertions=$(git diff --cached --numstat | awk '{sum+=$1} END {print sum+0}')
    local deletions=$(git diff --cached --numstat | awk '{sum+=$2} END {print sum+0}')

    echo "Files changed: $files_changed, Insertions: +$insertions, Deletions: -$deletions"
}

# Function to get optimized diff
get_optimized_diff() {
    local diff_lines=$(git diff --cached | wc -l)

    if [[ $diff_lines -gt $MAX_DIFF_LINES ]]; then
        print_warning "Diff is large ($diff_lines lines). Sending summary instead..."
        echo "=== Changed Files ==="
        git diff --cached --name-status
        echo ""
        echo "=== Statistics ==="
        git diff --cached --stat
    else
        git diff --cached
    fi
}

# Function to build the AI prompt
build_prompt() {
    local diff="$1"
    local prompt=""

    if [[ "$LANGUAGE" == "zh" ]]; then
        if [[ "$COMMIT_FORMAT" == "conventional" ]]; then
            prompt="请根据以下 git diff 生成一个简洁的 commit message。

要求：
1. 使用 Conventional Commits 格式：<type>(<scope>): <description>
2. type 可以是：feat, fix, docs, style, refactor, test, chore 等
3. scope 是可选的，表示影响的范围
4. description 用中文，简洁明了
5. 如果需要，可以添加一个空行后的详细说明
6. 不要包含 markdown 代码块（如 \`\`\`）

示例：
feat(auth): 添加用户登录功能
fix(ui): 修复按钮样式错误
docs: 更新 README 文档

git diff:
$diff"
        else
            prompt="请根据以下 git diff 生成一个简洁的中文 commit message，一行即可，不超过 50 字。不要包含 markdown 格式：

$diff"
        fi
    else
        if [[ "$COMMIT_FORMAT" == "conventional" ]]; then
            prompt="Generate a concise commit message based on the following git diff.

Requirements:
1. Use Conventional Commits format: <type>(<scope>): <description>
2. type can be: feat, fix, docs, style, refactor, test, chore, etc.
3. scope is optional, indicating the affected area
4. description should be clear and concise
5. If needed, add a blank line followed by detailed explanation
6. Do NOT use markdown code blocks or formatting

Examples:
feat(auth): add user login functionality
fix(ui): correct button styling issue
docs: update README documentation

git diff:
$diff"
        else
            prompt="Generate a concise commit message (one line, max 50 chars) based on the following git diff. Do NOT use markdown formatting:

$diff"
        fi
    fi

    echo "$prompt"
}

# Function to call AI model
call_ai_model() {
    local prompt="$1"
    local response=""

    # Check if using claude CLI
    if command -v claude &> /dev/null && [[ -n "${USE_CLAUDE_CLI:-}" ]]; then
        print_info "Using Claude CLI..."

        # Set environment variables if configured
        if [[ -n "${ANTHROPIC_AUTH_TOKEN:-}" ]]; then
            export ANTHROPIC_AUTH_TOKEN
        fi
        if [[ -n "${ANTHROPIC_BASE_URL:-}" ]]; then
            export ANTHROPIC_BASE_URL
        fi
        if [[ -n "${ANTHROPIC_MODEL:-}" ]]; then
            export ANTHROPIC_MODEL
        fi

        response=$(echo "$prompt" | claude --dangerously-skip-permissions 2>/dev/null || true)
    # Check if using direct API call
    elif [[ -n "${AI_API_URL:-}" ]] && [[ -n "${AI_API_KEY:-}" ]]; then
        print_info "Using API endpoint: ${AI_API_URL}..."

        local api_model="${AI_MODEL:-gpt-3.5-turbo}"

        # Prepare JSON payload
        local json_payload=$(jq -n \
            --arg model "$api_model" \
            --arg prompt "$prompt" \
            '{model: $model, messages: [{role: "user", content: $prompt}]}')

        # Call API
        response=$(curl -s "${AI_API_URL}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${AI_API_KEY}" \
            -d "$json_payload" | \
            jq -r '.choices[0].message.content // .content // empty' 2>/dev/null || true)
    else
        print_error "No AI model configured. Please set up your configuration in ${CONFIG_FILE}"
        print_info "See documentation for setup instructions."
        exit 1
    fi

    if [[ -z "$response" ]]; then
        print_error "Failed to get response from AI model"
        exit 1
    fi

    echo "$response"
}

# Function to show commit message and get user confirmation
confirm_commit() {
    local commit_msg="$1"

    echo "" >&2
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
    echo -e "${GREEN}Generated Commit Message:${NC}" >&2
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
    echo "$commit_msg" >&2
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
    echo "" >&2

    echo "Options:" >&2
    echo "  [y] Use this message" >&2
    echo "  [e] Edit this message" >&2
    echo "  [r] Regenerate message" >&2
    echo "  [n] Cancel" >&2
    echo "" >&2

    read -p "Your choice: " -n 1 -r choice
    echo "" >&2

    case $choice in
        y|Y)
            git commit -m "$commit_msg"
            print_success "Committed successfully!"
            return 0
            ;;
        e|E)
            # Create temp file with commit message
            local tmp_file=$(mktemp)
            echo "$commit_msg" > "$tmp_file"

            # Open in editor
            ${EDITOR:-nano} "$tmp_file"

            # Read edited message
            local edited_msg=$(cat "$tmp_file")
            rm "$tmp_file"

            if [[ -n "$edited_msg" ]]; then
                git commit -m "$edited_msg"
                print_success "Committed with edited message!"
                return 0
            else
                print_error "Empty commit message. Aborting."
                return 1
            fi
            ;;
        r|R)
            return 2  # Signal to regenerate
            ;;
        *)
            print_info "Commit cancelled."
            return 1
            ;;
    esac
}

# Function to show help
show_help() {
    cat << EOF
gac - AI-powered Git commit message generator

Usage: gac [options]

Options:
  -h, --help     Show this help message
  -v, --version  Show version information
  -c, --config   Show current configuration

Configuration:
  Edit ${CONFIG_FILE} to customize settings

Examples:
  git add .
  gac

For more information, see the README.
EOF
}

# Function to show current config
show_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        print_warning "No configuration file found at ${CONFIG_FILE}"
        print_info "Copy the example config to get started"
        return
    fi

    print_info "Current configuration from ${CONFIG_FILE}:"
    cat "$CONFIG_FILE"
}

# Main function
main() {
    # Parse arguments
    case "${1:-}" in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--version)
            echo "gac v1.0.0"
            exit 0
            ;;
        -c|--config)
            show_config
            exit 0
            ;;
    esac

    # Check prerequisites
    check_git_repo
    check_staged_changes

    # Show diff stats
    print_info "$(get_diff_stats)"
    echo "" >&2

    # Get diff
    local diff=$(get_optimized_diff)

    # Generate commit message (with retry option)
    local attempt=0
    while true; do
        ((++attempt))

        if [[ $attempt -gt 1 ]]; then
            print_info "Regenerating... (attempt $attempt)"
        fi

        print_info "Analyzing changes..."
        local prompt=$(build_prompt "$diff")
        local commit_msg=$(call_ai_model "$prompt")

        # Show and confirm
        confirm_commit "$commit_msg"
        local result=$?

        if [[ $result -eq 0 ]]; then
            break  # Success
        elif [[ $result -eq 2 ]]; then
            continue  # Regenerate
        else
            exit 1  # Cancelled or error
        fi
    done
}

# Run main function
main "$@"
